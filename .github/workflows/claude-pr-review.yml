name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop, main]

env:
  LINEAR_TEAM_PREFIX: "OKO"

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      # 1. Checkout with full history for diff
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Extract Linear Issue ID from branch/title/body
      - name: Extract Linear Issue ID
        id: extract-issue
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || '';

            // [DEBUG] Log input values
            console.log('=== [DEBUG] Extract Linear Issue ID ===');
            console.log(`Branch: ${branchName}`);
            console.log(`PR Title: ${prTitle}`);
            console.log(`PR Body: ${prBody.substring(0, 500)}${prBody.length > 500 ? '...' : ''}`);

            const teamPrefix = '${{ env.LINEAR_TEAM_PREFIX }}';
            const regex = new RegExp(`\\b(${teamPrefix}-\\d+)\\b`, 'i');

            let issueId = null;
            let source = null;

            // Priority: branch -> title -> body
            const branchMatch = branchName.match(regex);
            if (branchMatch) {
              issueId = branchMatch[1].toUpperCase();
              source = 'branch';
            }

            if (!issueId) {
              const titleMatch = prTitle.match(regex);
              if (titleMatch) {
                issueId = titleMatch[1].toUpperCase();
                source = 'title';
              }
            }

            if (!issueId) {
              const bodyMatch = prBody.match(regex);
              if (bodyMatch) {
                issueId = bodyMatch[1].toUpperCase();
                source = 'body';
              }
            }

            if (issueId) {
              core.setOutput('issue_id', issueId);
              core.setOutput('found', 'true');
              console.log(`[DEBUG] Found Linear issue: ${issueId} (from ${source})`);
            } else {
              core.setOutput('found', 'false');
              console.log('[DEBUG] No Linear issue found in branch, title, or body');
            }
            console.log('=== [DEBUG] End Extract ===');

      # 3. Fetch Linear Issue details
      - name: Fetch Linear Issue
        id: linear-issue
        if: steps.extract-issue.outputs.found == 'true'
        uses: actions/github-script@v7
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        with:
          script: |
            const issueId = '${{ steps.extract-issue.outputs.issue_id }}';
            const match = issueId.match(/^([A-Z]+)-(\d+)$/);

            if (!match) {
              core.setOutput('success', 'false');
              console.log(`Invalid issue identifier format: ${issueId}`);
              return;
            }

            const [, teamKey, issueNumber] = match;

            const query = `
              query GetIssue($teamKey: String!, $issueNumber: Float!) {
                issues(
                  filter: {
                    number: { eq: $issueNumber }
                    team: { key: { eq: $teamKey } }
                  }
                  first: 1
                ) {
                  nodes {
                    id
                    identifier
                    title
                    description
                    state { name type }
                    labels { nodes { name } }
                  }
                }
              }
            `;

            console.log('=== [DEBUG] Fetch Linear Issue ===');
            console.log(`[DEBUG] Querying: teamKey=${teamKey}, issueNumber=${issueNumber}`);

            try {
              const response = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.LINEAR_API_KEY}`
                },
                body: JSON.stringify({
                  query,
                  variables: {
                    teamKey,
                    issueNumber: parseInt(issueNumber)
                  }
                })
              });

              const result = await response.json();

              // [DEBUG] Log full API response
              console.log('[DEBUG] Linear API Response:');
              console.log(JSON.stringify(result, null, 2));

              if (result.errors) {
                console.log('[DEBUG] Linear API Error:', JSON.stringify(result.errors));
                core.setOutput('success', 'false');
                return;
              }

              const issue = result.data?.issues?.nodes?.[0];

              if (!issue) {
                console.log(`[DEBUG] Issue not found: ${issueId}`);
                core.setOutput('success', 'false');
                return;
              }

              // [DEBUG] Log parsed values
              console.log('[DEBUG] Parsed Issue Data:');
              console.log(`  - Identifier: ${issue.identifier}`);
              console.log(`  - Title: ${issue.title}`);
              console.log(`  - State: ${issue.state?.name} (${issue.state?.type})`);
              console.log(`  - Labels: ${(issue.labels?.nodes || []).map(l => l.name).join(', ') || 'none'}`);
              console.log(`  - Description length: ${(issue.description || '').length} chars`);
              console.log(`  - Description preview: ${(issue.description || '').substring(0, 300)}${(issue.description || '').length > 300 ? '...' : ''}`);

              core.setOutput('success', 'true');
              core.setOutput('title', issue.title || '');
              core.setOutput('description', issue.description || 'No description provided');
              core.setOutput('state', issue.state?.name || 'Unknown');
              core.setOutput('labels', (issue.labels?.nodes || []).map(l => l.name).join(', '));

              console.log(`[DEBUG] Successfully fetched: ${issue.identifier} - ${issue.title}`);
            } catch (error) {
              console.log(`[DEBUG] Failed to fetch Linear issue: ${error.message}`);
              core.setOutput('success', 'false');
            }
            console.log('=== [DEBUG] End Fetch ===');

      # 4. Get changed files list
      - name: Get Changed Files
        id: changed-files
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.sha }} | head -50)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # [DEBUG] Print final context
      - name: "[DEBUG] Print Review Context"
        run: |
          echo "=== [DEBUG] Final Review Context ==="
          echo "Linear Issue Found: ${{ steps.extract-issue.outputs.found }}"
          echo "Linear Issue ID: ${{ steps.extract-issue.outputs.issue_id }}"
          echo "Linear API Success: ${{ steps.linear-issue.outputs.success }}"
          echo "Linear Title: ${{ steps.linear-issue.outputs.title }}"
          echo "Linear State: ${{ steps.linear-issue.outputs.state }}"
          echo "Linear Labels: ${{ steps.linear-issue.outputs.labels }}"
          echo "---"
          echo "Linear Description:"
          echo "${{ steps.linear-issue.outputs.description }}"
          echo "---"
          echo "Changed Files:"
          echo "${{ steps.changed-files.outputs.files }}"
          echo "=== [DEBUG] End Context ==="

      # 5. Run Claude review
      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Please review this PR.

            ## Linear Ticket Information
            - **Issue ID**: ${{ steps.extract-issue.outputs.found == 'true' && steps.extract-issue.outputs.issue_id || 'Not linked' }}
            - **Title**: ${{ steps.linear-issue.outputs.success == 'true' && steps.linear-issue.outputs.title || 'N/A' }}
            - **State**: ${{ steps.linear-issue.outputs.success == 'true' && steps.linear-issue.outputs.state || 'N/A' }}
            - **Labels**: ${{ steps.linear-issue.outputs.success == 'true' && steps.linear-issue.outputs.labels || 'N/A' }}

            ## Linear Ticket Spec/Description
            ${{ steps.linear-issue.outputs.success == 'true' && steps.linear-issue.outputs.description || 'No Linear ticket linked to this PR.' }}

            ## Changed Files
            ${{ steps.changed-files.outputs.files }}

            ## Review Criteria

            ### 1. Spec Compliance (if Linear ticket exists)
            - Verify all requirements from the Linear ticket are implemented
            - Check for scope creep beyond the spec
            - Evaluate implementation completeness (0-100%)

            ### 2. Code Quality
            - Adherence to project coding conventions (Biome, TypeScript strict)
            - Preference for Rust-style patterns (Result, Option patterns, etc.)
            - Unnecessary complexity
            - Security vulnerabilities

            ## Response Format

            Please provide your review in the following format:

            ### Spec Implementation Status
            (Only if Linear ticket exists)
            - Implemented items
            - Missing items
            - Implementation completeness: X%

            ### Code Review
            - Key feedback (if any)
            - Improvement suggestions (if any)

            ### Final Verdict
            - APPROVE / REQUEST_CHANGES / COMMENT with reasoning
          allowed_tools: |
            Read
            Glob
            Grep
          model: claude-sonnet-4-5-20250929
